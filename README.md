# Brain Tumor Detection â€” Bounding-Box Segmentation with YOLOv8  
**Author: Omar Madjitov**  
**Course: CSC 6850 â€” Machine Learning (Fall 2025)**  

---

## ğŸ“Œ Overview

This repository contains my full pipeline for training, validating, and evaluating a **brain-tumor detection model** using **YOLOv8**.  

Originally, the project was defined as a **semantic segmentation** task. However, after inspecting the dataset, I discovered that **all COCO â€œsegmentationsâ€ were rectangular polygons**, meaning the dataset **does not contain true pixel-accurate masks**. Every segmentation polygon is just a rectangle describing a tumor region.

Because of this, UNet (which requires organic, pixel-level masks) plateaued at **IoU â‰ˆ 0.66**. I later confirmed that this was not an architecture failureâ€”**the datasetâ€™s mask geometry made true segmentation impossible**.

To correctly match the datasetâ€™s nature, I redesigned the project as a **single-class bounding-box detection task** and implemented the complete pipeline with **YOLOv8-s**.

This repository includes:
- Full training pipeline  
- COCO â†’ YOLO conversion  
- Raw IoU and pixel-accuracy evaluation  
- Test-set inference  
- COCO JSON reconstruction for grading  
- Visualizations  
- Fully reproducible Jupyter notebook  

---

## âš ï¸ Important Disclaimer â€” Training Performed on a MacBook (MPS Backend)

All training and inference steps in this project were executed on:

- **MacBook Pro (M4 Max)**  
- **PyTorch MPS backend**

If you are running this on **Windows or Linux**, MPS will not be available.  

You must switch the device selection logic inside the notebook:

### On my machine:
```python
device = "mps"

On your machine (PC or Linux):

Use CUDA if you have an NVIDIA GPU:

device = "cuda"

Or CPU:

device = "cpu"

Recommended tools for PC users:
	â€¢	NVIDIA GPU with CUDA 12.x
	â€¢	PyTorch with CUDA support
	â€¢	ultralytics==8.3.x
	â€¢	Python 3.10 â€“ 3.12

If you run into backend errors, this will be the reason.

â¸»

ğŸ—‚ï¸ Project Structure

GROUP PROJECT/
â”‚
â”œâ”€â”€ dataset/
â”‚   â”œâ”€â”€ train/
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ labels/            â† YOLO-formatted labels
â”‚   â”œâ”€â”€ valid/
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ labels/
â”‚   â”œâ”€â”€ test/
â”‚       â”œâ”€â”€ images/
â”‚       â””â”€â”€ labels/            â† Empty before prediction â†’ filled after YOLO run
â”‚   â””â”€â”€ dataset.yaml
â”‚
â”œâ”€â”€ experiments/
â”‚   â”œâ”€â”€ yolo_run8/             â† main trained model
â”‚   â”œâ”€â”€ yolo_run8_val_preds/   â† validation predictions
â”‚   â””â”€â”€ yolo_run8_test_preds/  â† test predictions
â”‚
â”œâ”€â”€ src/
â”‚   â””â”€â”€ 05_yolo_pipeline.ipynb â† full notebook (training â†’ evaluation â†’ test)
â”‚
â””â”€â”€ README.md


â¸»

ğŸ› ï¸ Installation

Clone the repository:

git clone https://github.com/yourusername/brain-tumor-yolo.git
cd brain-tumor-yolo

Install dependencies:

pip install -r requirements.txt

If you are on Windows/Linux with an NVIDIA GPU:

pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121


â¸»

ğŸ“„ dataset.yaml (autogenerated)

path: ../dataset
train: train/images
val: valid/images
test: test/images

names:
  0: tumor


â¸»

ğŸš€ How to Run the Notebook

Open Jupyter:

jupyter notebook

Run the notebook:

src/05_yolo_pipeline.ipynb

The notebook executes the entire pipeline in this order:
	1.	Dataset sanity checks
	2.	COCO â†’ YOLO label conversion
	3.	Cache cleanup
	4.	YOLOv8 training
	5.	Prediction on validation set
	6.	Raw IoU computation
	7.	Pixel accuracy computation
	8.	Test-set prediction
	9.	Copy predictions into dataset/test/labels/
	10.	COCO JSON reconstruction for grading
	11.	Visualization samples

Everything is reproducible.

â¸»

ğŸ§  Model Training Summary

Final validation performance:

Metric	Score
Mean IoU	0.7299
Pixel Accuracy	0.9097
mAP@50	0.905

This exceeds the courseâ€™s required thresholds:

Requirement	Threshold	Achieved
IoU	â‰¥ 0.70	0.7299
Pixel Accuracy	â‰¥ 0.75	0.9097


â¸»

ğŸ“Š Visualizations

During validation and test evaluation, the notebook automatically generates:
	â€¢	Predicted bounding boxes
	â€¢	Overlay of predictions vs ground truth
	â€¢	Random qualitative samples
	â€¢	YOLO training curves (loss, precision, recall, F1, PR curve)

Examples are stored in:

experiments/yolo_run8/
experiments/yolo_run8_val_preds/
experiments/yolo_run8_test_preds/


â¸»

ğŸ§ª Running Inference on the Test Set

YOLO predictions on test images:

!yolo predict \
    model=../experiments/yolo_run8/weights/best.pt \
    source=../dataset/test/images \
    save_txt=True \
    save_conf=True \
    conf=0.40 \
    project=../experiments \
    name=yolo_run8_test_preds

Copy YOLO outputs into the test labels folder:

import shutil, os

src = "../experiments/yolo_run8_test_preds/labels"
dst = "../dataset/test/labels"

for f in os.listdir(src):
    shutil.copy(os.path.join(src, f), os.path.join(dst, f))

print("Test labels copied.")


â¸»

ğŸ§¾ Generating COCO JSON for the Test Set

A full conversion script is included in the notebook.
It reconstructs a valid _annotations.coco.json with fields:
	â€¢	info
	â€¢	licenses
	â€¢	categories
	â€¢	images
	â€¢	annotations

All bounding boxes are converted from YOLO normalized coordinates â†’ COCO absolute coordinates.

Output saved to:

dataset/test/_annotations.coco.json


â¸»

ğŸ“š Requirements

requirements.txt:

ultralytics==8.3.233
torch==2.9.1
torchvision==0.20.1

numpy
opencv-python
matplotlib
tqdm
pyyaml

pandas
scikit-learn
albumentations
jupyter


â¸»

ğŸ Final Notes

I wrote this repository so the grader â€” or any ML engineer evaluating my work â€” can run it end-to-end with zero ambiguity.
	â€¢	The notebook is fully reproducible.
	â€¢	Every step is explained and automated.
	â€¢	The project uses bounding-box detection because the dataset does not contain real segmentation masks.
	â€¢	All evaluation metrics match the projectâ€™s learning objectives.

If you have a CUDA GPU, training will run much faster than on MPS.
If you have questions, feel free to reach out through GitHub.

â¸»

# ğŸ”§ Troubleshooting & Common Issues

While preparing this project, I encountered several pitfalls related to:

- dataset formatting  
- COCO vs YOLO label inconsistencies  
- unsupported augmentations on MPS  
- cached label mismatches  
- YOLO predicting hundreds of bounding boxes when `conf=0.0`  
- proper filtering of predictions  

To help you avoid the same issues, Iâ€™ve included a troubleshooting guide below.

---

## â— Troubleshooting Guide

### 1. **YOLO Predicts Hundreds of Boxes Per Image**
If you see something like:

300 tumors detected

This simply means you are using:

conf=0.0

YOLO will output **every box before NMS filtering**.

**Fix:**
Use a realistic confidence threshold:
```bash
conf=0.40


â¸»

2. MPS Not Supported / Crashing

If you are on Windows or Linux, remove:

device = "mps"

Use:

device = "cuda"    # if NVIDIA GPU exists

or:

device = "cpu"


â¸»

3. YOLO Errors with .cache Files

If your dataset changes, you must clear YOLOâ€™s cache:

import glob, os

for c in glob.glob("../dataset/**/*.cache", recursive=True):
    os.remove(c)


â¸»

4. COCO â†’ YOLO Conversion Produces Missing Labels

This occurs when images exist but labels do not.

The notebook automatically removes corrupted labels:

if not exists_image:
    os.remove(label_file)


â¸»

5. Raw IoU Returns Zero

If IoU = 0 for all images:
	â€¢	You may have used segmentation masks instead of bounding boxes.
	â€¢	You may have compared normalized YOLO coordinates with absolute COCO coordinates.
	â€¢	You may not have selected the highest-confidence predicted box.

The notebook fixes this by:
	â€¢	taking the top-1 prediction
	â€¢	converting YOLO â†’ absolute box coords
	â€¢	computing IoU safely

â¸»

6. Pixel Accuracy > 0.90 Is Expected

Pixel accuracy is almost always high for tumor detection datasets because:
	â€¢	~95% of pixels are background
	â€¢	only a small region is tumor

This is normal.Here is a polished, professional, and improved version of your `README.md`. I have restructured it to follow standard engineering documentation practices while preserving your personal narrative and specific course requirements.

You can copy the code block below directly into your `README.md` file.

````markdown
# ğŸ§  Brain Tumor Detection â€” Bounding-Box Segmentation with YOLOv8

**Author:** Omar Madjitov  
**Course:** CSC 6850 â€” Machine Learning (Fall 2025)

![Python](https://img.shields.io/badge/Python-3.10%2B-blue)
![PyTorch](https://img.shields.io/badge/PyTorch-2.0%2B-orange)
![YOLOv8](https://img.shields.io/badge/YOLO-v8-green)

---

## ğŸ“Œ Overview

This repository contains a complete pipeline for training, validating, and evaluating a **brain-tumor detection model** using **YOLOv8**.

### ğŸ”„ The Pivot: From Segmentation to Detection
Originally, this project was defined as a **semantic segmentation** task. However, a deep audit of the provided dataset revealed a critical flaw: **all COCO "segmentation" masks were perfect rectangular polygons**. The dataset did not contain organic, pixel-accurate tumor boundariesâ€”only boxes.

Consequently, standard segmentation architectures like **UNet** failed to learn effective boundaries, plateauing at **IoU â‰ˆ 0.66**. To align the modeling approach with the actual geometry of the data, I re-engineered the project as a **single-class bounding-box detection task** using **YOLOv8-s**.

### ğŸ“¦ Repository Contents
- âœ… **End-to-End Pipeline:** Data ingestion $\rightarrow$ Training $\rightarrow$ Inference.
- âœ… **Custom Converters:** COCO JSON $\leftrightarrow$ YOLO TXT format conversion.
- âœ… **Evaluation:** Raw IoU, Pixel Accuracy, and mAP calculation.
- âœ… **Reproducibility:** A fully automated Jupyter notebook (`src/05_yolo_pipeline.ipynb`).

---

## ğŸ† Key Results

The final YOLOv8-s model significantly outperformed the initial UNet attempts and exceeded the course thresholds.

| Metric | Threshold | **Achieved** |
| :--- | :--- | :--- |
| **Mean IoU** | $\ge$ 0.70 | **0.7299** |
| **Pixel Accuracy** | $\ge$ 0.75 | **0.9097** |
| **mAP@50** | N/A | **0.905** |

> *Note: Pixel accuracy is naturally high (>0.90) in tumor detection because the vast majority of the MRI scan is background.*

---

## âš ï¸ Hardware Disclaimer (MacBook MPS vs. CUDA)

**This project was developed and executed on a MacBook Pro (M4 Max) using the PyTorch MPS backend.**

### ğŸ’» For Windows / Linux Users
If you are running this on a PC with an NVIDIA GPU, you **must** update the device selection logic in the notebook.

**In `src/05_yolo_pipeline.ipynb`:**

```python
# Change this line:
device = "mps" 

# To this (for NVIDIA GPUs):
device = "cuda"

# Or this (for CPU only):
device = "cpu"
````

**Recommended Environment:**

  * **GPU:** NVIDIA with CUDA 12.x
  * **Libraries:** `ultralytics==8.3.x`, `torch` (CUDA supported)
  * **Python:** 3.10 â€“ 3.12

-----

## ğŸ› ï¸ Installation

1.  **Clone the repository:**

    ```bash
    git clone [https://github.com/yourusername/brain-tumor-yolo.git](https://github.com/yourusername/brain-tumor-yolo.git)
    cd brain-tumor-yolo
    ```

2.  **Install dependencies:**

    ```bash
    pip install -r requirements.txt
    ```

    *(See `requirements.txt` section below for exact versions)*

3.  **(Optional) Install PyTorch with CUDA:**
    If you are on Windows/Linux, ensure you have the correct PyTorch version:

    ```bash
    pip install torch torchvision --index-url [https://download.pytorch.org/whl/cu121](https://download.pytorch.org/whl/cu121)
    ```

-----

## ğŸš€ How to Run

The entire workflow is encapsulated in a single Jupyter notebook for maximum reproducibility.

1.  **Launch Jupyter:**

    ```bash
    jupyter notebook
    ```

2.  **Open and Run:**
    Navigate to `src/05_yolo_pipeline.ipynb` and run all cells.

### âš™ï¸ Pipeline Steps (Automated)

The notebook executes the following sequence:

1.  **Sanity Checks:** Verifies image/label integrity.
2.  **Conversion:** Transforms COCO JSON annotations to YOLO format.
3.  **Cleanup:** Removes old `.cache` files to prevent data leakage.
4.  **Training:** Fine-tunes `yolov8s.pt` for 30 epochs.
5.  **Validation:** Generates predictions on the validation set.
6.  **Evaluation:** Computes raw IoU and Pixel Accuracy.
7.  **Testing:** Runs inference on the blind test set.
8.  **Reconstruction:** Converts YOLO predictions back to COCO JSON for grading.

-----

## ğŸ—‚ï¸ Project Structure

```text
GROUP PROJECT/
â”‚
â”œâ”€â”€ dataset/
â”‚   â”œâ”€â”€ train/                 # Training images & labels
â”‚   â”œâ”€â”€ valid/                 # Validation images & labels
â”‚   â”œâ”€â”€ test/                  # Test images (labels generated by model)
â”‚   â””â”€â”€ dataset.yaml           # Auto-generated YOLO config
â”‚
â”œâ”€â”€ experiments/
â”‚   â”œâ”€â”€ yolo_run8/             # Trained model weights & logs
â”‚   â”œâ”€â”€ yolo_run8_val_preds/   # Validation set outputs
â”‚   â””â”€â”€ yolo_run8_test_preds/  # Test set outputs
â”‚
â”œâ”€â”€ src/
â”‚   â””â”€â”€ 05_yolo_pipeline.ipynb # MAIN NOTEBOOK
â”‚
â””â”€â”€ README.md
```

-----

## ğŸ”§ Troubleshooting Guide

During development, I encountered specific issues related to dataset formatting and backend compatibility. Here is how to resolve them:

### 1\. YOLO Predicts Hundreds of Boxes (`300+ tumors detected`)

**Cause:** This happens if you set `conf=0.0`. YOLO outputs every candidate box before Non-Maximum Suppression (NMS).
**Fix:** Use a realistic confidence threshold (e.g., `conf=0.40`).

### 2\. Backend Errors / Crashing

**Cause:** Trying to use `device='mps'` on a Windows/Linux machine.
**Fix:** Switch to `device='cuda'` or `device='cpu'` as described in the Hardware Disclaimer.

### 3\. Missing Labels after Conversion

**Cause:** Some images in the source dataset may not have corresponding annotations.
**Fix:** The notebook includes a script that automatically aligns images and labels:

```python
if not exists_image:
    os.remove(label_file)
```

### 4\. Raw IoU Returns Zero

**Cause:** Mismatch between normalized YOLO coordinates (0-1) and absolute COCO coordinates (pixels).
**Fix:** The notebook handles coordinate denormalization automatically before computing metrics.

-----

## ğŸ“¦ Deliverables

Upon successful execution, the following files are generated:

| File | Description |
| :--- | :--- |
| `experiments/yolo_run8/weights/best.pt` | The final trained model weights. |
| `val_iou_pixel_accuracy.json` | Calculated performance metrics. |
| `dataset/test/_annotations.coco.json` | Reconstructed COCO JSON for grading/submission. |
| `experiments/yolo_run8_test_visuals/` | Overlay visualizations of model predictions. |

-----

## ğŸ“š Requirements

**`requirements.txt`**

```text
ultralytics==8.3.233
torch==2.9.1
torchvision==0.20.1
numpy
opencv-python
matplotlib
tqdm
pyyaml
pandas
scikit-learn
albumentations
jupyter
```

-----

## ğŸ“¨ Contact

If you have questions about the pipeline or the dataset analysis, please feel free to reach out.

**Omar Madjitov** ğŸ“§ omar.madjitov@email.com  
ğŸ”— [LinkedIn Profile](https://www.linkedin.com/in/omar-madjitov-6b3a33234/)

-----

*Thank you for reviewing my work\!*

```
```

â¸»

ğŸ“¤ How to Reproduce Training from Scratch

If you want to fully retrain the model:

Step 1 â€” Convert COCO â†’ YOLO

Run the first half of the notebook:
	â€¢	sanity check images
	â€¢	convert annotations
	â€¢	clean corrupted labels
	â€¢	delete .cache files

Step 2 â€” Train YOLOv8

model = YOLO("yolov8s.pt")

model.train(
    data="../dataset/dataset.yaml",
    epochs=30,
    imgsz=640,
    batch=8,
    device=device,
    task="detect",
    project="../experiments",
    name="yolo_run8",
    save=True,
    save_period=1,
    fliplr=0.5,
    flipud=0.0,
    augment=False
)

Step 3 â€” Save Predictions for Validation and Test

The notebook includes:

!yolo predict ...


â¸»

ğŸ“¦ Deliverables Generated

After running the notebook, the following deliverables are created automatically:

âœ” best.pt

Final YOLO weights.

âœ” val_iou_pixel_accuracy.json

Computed IoU + pixel accuracy for the validation set.

âœ” _annotations.coco.json (Test Set)

Reconstructed COCO JSON for grading.

âœ” 5 Random Visualization Overlays

Stored in:

experiments/yolo_run8_test_visuals/

âœ” YOLO Metrics

Plot files:
	â€¢	precision curve
	â€¢	recall curve
	â€¢	PR curve
	â€¢	confusion matrix
	â€¢	training loss curves

â¸»

ğŸ“‘ Academic Integrity & Project Notes

I include this section so the grader understands my research process.

âœ” Why UNet Didnâ€™t Work

UNet expects organic, pixel-accurate segmentation masks.
But this dataset contains only rectangular polygons.
UNet cannot infer tumor shape from rectangular masks; the model saturates early.

âœ” Why YOLO Works Better

YOLO is designed for bounding box detection.
Bounding boxes are exactly what the dataset contains.
Therefore, YOLO matches the datasetâ€™s geometry perfectly.

âœ” Final Performance

YOLO produced:
	â€¢	IoU: 0.7299
	â€¢	Pixel Accuracy: 0.9097
	â€¢	mAP@50: 0.905

These exceed the required thresholds for the course.

â¸»

ğŸ§­ Summary for GitHub Readers

This repository demonstrates:

âœ” proper dataset auditing
âœ” custom COCO â†’ YOLO conversion
âœ” robust training methodology
âœ” reproducible evaluation
âœ” bounding-box based reconstruction of COCO labels
âœ” high-quality visualizations
âœ” clean project organization
âœ” clear delivery pipeline

It reflects my ability to:
	â€¢	analyze dataset structure
	â€¢	design the correct ML task
	â€¢	build pipelines end-to-end
	â€¢	evaluate models correctly
	â€¢	document work for both graders and engineers

â¸»

ğŸ“¨ Contact

If you need help running the project or you want to discuss the pipeline, you can reach me anytime:

Omar Madjitov
ğŸ“§ omar.madjitov@email.com
ğŸ”— https://www.linkedin.com/in/omar-madjitov-6b3a33234/

â¸»

Thank you for reviewing my work!




